

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>scc_multiverse.menu.main_recipe &mdash; SCC Multiverse  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SCC Multiverse
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SCC Multiverse</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../menu.html">scc_multiverse.menu</a> &raquo;</li>
        
      <li>scc_multiverse.menu.main_recipe</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for scc_multiverse.menu.main_recipe</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">descriptors</span> <span class="kn">import</span> <span class="n">cachedproperty</span>
<span class="kn">from</span> <span class="nn">distributed.client</span> <span class="kn">import</span> <span class="n">_get_global_client</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span><span class="p">,</span> <span class="n">progress</span>

<span class="kn">from</span> <span class="nn">scc_multiverse.menu.decorators</span> <span class="kn">import</span> <span class="n">save</span>
<span class="kn">from</span> <span class="nn">scc_multiverse.menu.simple_storage</span> <span class="kn">import</span> <span class="n">StackedDamages</span><span class="p">,</span> <span class="n">EconVars</span>
<span class="kn">from</span> <span class="nn">scc_multiverse.fair.estimations</span> <span class="kn">import</span> <span class="p">(</span><span class="n">estimate_damages_betas</span><span class="p">,</span>
                                             <span class="n">compute_damages</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">scc_multiverse.fair.utils</span> <span class="kn">import</span> <span class="n">get_the_hats</span>

<span class="kn">from</span> <span class="nn">scc_multiverse</span> <span class="kn">import</span> <span class="n">LOGGER</span>

<span class="n">CONST_DISC_RATES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="n">DIM_CHOICES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;gcm&#39;</span><span class="p">,</span> <span class="s1">&#39;rcp&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">DISCOUNT_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="s1">&#39;ramsey&#39;</span><span class="p">,</span> <span class="s1">&#39;wr&#39;</span><span class="p">]</span>
<span class="n">DISCOUNT_LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="MainRecipe"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe">[docs]</a><span class="k">class</span> <span class="nc">MainRecipe</span><span class="p">(</span><span class="n">StackedDamages</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main Recipe for SCC calculation across menu options.</span>

<span class="sd">    This class is a BaseClass for all recipe classes in the menu of SCC</span>
<span class="sd">    options. Here we will instantiate a class with the common elements across</span>
<span class="sd">    menu options and then also layout an order of implementation.</span>

<span class="sd">    This class is *not* designed to be directly instantiated by the user.</span>
<span class="sd">    Instead, it is called in the different menu options: `EquityRecipe`,</span>
<span class="sd">    `RiskAversionRecipe`, and `Baseline`.</span>

<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>
<span class="sd">    sector_path : str</span>
<span class="sd">        Path to sector damages. The path can point to the root folder, and then</span>
<span class="sd">        the `damages_directory` can be used to point where monetized damages</span>
<span class="sd">        are stored.</span>
<span class="sd">    econ_vars : :obj:`simple_storage.EconVars` </span>
<span class="sd">        This is a `simple_storage.EconVars` class with population and income</span>
<span class="sd">        data.</span>
<span class="sd">    cons_clip : int</span>
<span class="sd">        It is possible that some damages are so extreme that will yield</span>
<span class="sd">        negative consumptions (gdppc - damages). Hence, we need to bottom code</span>
<span class="sd">        the consumptions. This value is then the minumum consumption per capita</span>
<span class="sd">        for those impact regions with extreme damages. If `cons_clip` is</span>
<span class="sd">        `None`, we will assign the current minimum `gdppc` as the value for</span>
<span class="sd">        bottom clip consumption.</span>
<span class="sd">    discounting_type : str</span>
<span class="sd">        A discount type to calculate the CE consumption. Options available</span>
<span class="sd">        are:</span>
<span class="sd">            - `&#39;constant&#39;`: A constant discount rate</span>
<span class="sd">            - `&#39;ramsey&#39;`: A ramsey discount rate (based on GDP growth rate)</span>
<span class="sd">            - `&#39;wr&#39;`: A Weitzman-Ramsey discounting (base on GDP growth</span>
<span class="sd">              rate and additionally collapsing across different economic</span>
<span class="sd">              scenarios). </span>
<span class="sd">    discounting_level : str</span>
<span class="sd">        Menu options vary on their level of discounting, here we can choose</span>
<span class="sd">        between `local` or `global`.</span>
<span class="sd">    fit_type : str</span>
<span class="sd">        Fitting option for damage yearly damage function estimation. The valid</span>
<span class="sd">        options are &#39;ols&#39; or &#39;quantiles&#39;.</span>
<span class="sd">    subset_dict : dict</span>
<span class="sd">        A dictionary where you can define a filtering criteria. Keys must be</span>
<span class="sd">        damages dimensions, and values should be the desired values for that</span>
<span class="sd">        dimension.</span>
<span class="sd">        For instance:</span>
<span class="sd">        ```</span>
<span class="sd">        subset_dict = {batch: &#39;batch1&#39;,</span>
<span class="sd">                      &#39;gcm&#39;: &#39;ACCESS0-1&#39;}</span>
<span class="sd">        ```</span>

<span class="sd">        This `dict` above will filter the damages to only the &#39;batch1&#39; and the</span>
<span class="sd">        &#39;ACCESS0-1&#39; global climate model.</span>

<span class="sd">    **extrapolation_kwargs</span>
<span class="sd">        Other parameters to be passed to extraplation calculation. See</span>
<span class="sd">        `simple_storage.EconVars.extrapolation` for more details</span>
<span class="sd">    **fitting_kwargs</span>
<span class="sd">        Other parameteres to be passed to the `damage_function` method.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ce_cc : xr.DataArray</span>
<span class="sd">        Certainty equivalent consumption under climate change scenario</span>
<span class="sd">    ce_no_cc : xr.DataArray</span>
<span class="sd">        Certainty equivalent consumption under no climate change scenario</span>
<span class="sd">    global_damages : xr.DataArray</span>
<span class="sd">        Global damages (collapsed IRs) for a defined discounting option.</span>
<span class="sd">    damage_function_points : pd.DataFrame</span>
<span class="sd">        Yearly model/Batch global damage realizations for GCM temperature anomalies.</span>
<span class="sd">    damage_function_coefficients : xr.Dataset</span>
<span class="sd">        Data array with coefficients from the cuadratic fit of damages using</span>
<span class="sd">        temperature anomalies. These values are linearly extrapolated to go</span>
<span class="sd">        beyond 2100.</span>
<span class="sd">    damage_function : xr.Dataset</span>
<span class="sd">        Data array with predicted damages for different temperature anomaly</span>
<span class="sd">        levels.</span>
<span class="sd">    fair_marginal_damages : xr.Dataset</span>
<span class="sd">        Raw FAIR marginal damages resulting from the substraction of pulse and</span>
<span class="sd">        RCP damages</span>
<span class="sd">    global_consumption : xr.Dataset</span>
<span class="sd">        Total global available consumption after damages. This value is</span>
<span class="sd">        calculated using the no climate change scenario and using an</span>
<span class="sd">        extrapolation to cover values beyond 2100.</span>
<span class="sd">    global_consumption_no_pulse: xr.DataArray</span>
<span class="sd">        Total global consumption available under FAIR RCP scenario</span>
<span class="sd">    global_consumption_pulse : xr.Dataset</span>
<span class="sd">        Total global consumption avialable under FAIR pulse scenario</span>
<span class="sd">    ce_fair_pulse_damages : xr.Dataset</span>
<span class="sd">        Certainty equivalent consumption of FAIR pulse consumptions</span>
<span class="sd">    ce_fair_no_pulse_damages : xr.Dataset</span>
<span class="sd">        Certainty equivalent consumption of FAIR RCP consumption</span>
<span class="sd">    fair_marginal_damages_ce : xr.Dataset</span>
<span class="sd">        FAIR marginal damages using certainty equivalent consumptions. These</span>
<span class="sd">        values should be higher than `fair_marginal_damages`</span>
<span class="sd">    calculate_scc : xr.Dataset</span>
<span class="sd">        Discounted damages using the class defined discounting method. </span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    order_place</span>
<span class="sd">        Run recipe pipeline and calculate all objects. If `save_path` is</span>
<span class="sd">        specificed, results will be saved in disk, otherwise, results will be</span>
<span class="sd">        cached.</span>
<span class="sd">    c_equivalence</span>
<span class="sd">        Calculate certainty equivalence over array</span>
<span class="sd">    discounted_fair_damages</span>
<span class="sd">        Discounnt damages to present values using different discounting</span>
<span class="sd">        schemes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">REFERENCE_YEAR</span> <span class="o">=</span> <span class="mi">1765</span>
    <span class="n">START_YEAR</span> <span class="o">=</span> <span class="mi">2015</span>
    <span class="n">PULSE_YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
    <span class="n">PULSE_AMT</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">MAGNITUDE_OF_DAMAGES</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">PULSE_CONVERSION</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">PULSE_AMT</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="mf">12.011</span> <span class="o">/</span> <span class="mf">44.0098</span>
    <span class="n">BASEPERIOD</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">2010</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sector_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">econ_vars</span><span class="p">,</span> <span class="n">climate_vars</span><span class="p">,</span>
                 <span class="n">discounting_type</span><span class="p">,</span> <span class="n">discounting_level</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span>
                 <span class="n">subset_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cons_clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                 <span class="n">sector</span><span class="o">=</span><span class="s1">&#39;integration&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sector_path</span><span class="p">,</span> <span class="n">econ_vars</span><span class="p">,</span>
                         <span class="n">climate_vars</span><span class="p">,</span> <span class="n">cons_clip</span><span class="p">,</span> <span class="n">subset_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_type</span> <span class="o">=</span> <span class="n">fit_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discounting_level</span> <span class="o">=</span> <span class="n">discounting_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">=</span> <span class="n">discounting_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">const_disc_rates</span> <span class="o">=</span> <span class="n">CONST_DISC_RATES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_start_year</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_year&#39;</span><span class="p">,</span> <span class="mi">2085</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_end_year</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_year&#39;</span><span class="p">,</span> <span class="mi">2100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_end_year</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interp_year&#39;</span><span class="p">,</span> <span class="mi">2300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Running </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="si">}</span><span class="s1"> class with the following parameters: </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Sector: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> 
            <span class="sa">f</span><span class="s1">&#39;Path to damages: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Discount level: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_level</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Discount type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">repr_text</span>

<div class="viewcode-block" id="MainRecipe.order_plate"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.order_plate">[docs]</a>    <span class="k">def</span> <span class="nf">order_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">course</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute menu option section and save results</span>

<span class="sd">        This method is a entry point to the class and allows the user to</span>
<span class="sd">        calculate different elements of a specific menu option, these elements</span>
<span class="sd">        will automatically be saved in the path defined in `save_path`. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        course str</span>
<span class="sd">            A menu section to order. The following are the available options: </span>
<span class="sd">                - `damage_function`: Return and save all damage function</span>
<span class="sd">                  elements including model realizations, fit coefficients, and</span>
<span class="sd">                  estimated damages curves</span>
<span class="sd">                - `fair_ce`: Return and save all elements related with FAIR</span>
<span class="sd">                  steps including global consumptions and FAIR damages for both</span>
<span class="sd">                  pulse and control runs. Additionally, all elements from</span>
<span class="sd">                  `damage_function` will be returned and saved. </span>
<span class="sd">                - `scc`: Return Social Cost of Carbon calculation for FAIR</span>
<span class="sd">                  medians and full-uncertainty. See class documents for more</span>
<span class="sd">                  details. All elements from `fair_ce` and `damage_function`</span>
<span class="sd">                  are alsos saved and returned. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None. Saved all elements to `save_path`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Executing </span><span class="se">\U0001F4D9</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">damage_function</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F916</span><span class="s1"> Processing Damage Functions ...&#39;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F4C8</span><span class="s1"> Drawing and saving ...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">damage_function</span>

        <span class="k">def</span> <span class="nf">fair_ce</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span> <span class="o">!=</span> <span class="s1">&#39;adding_up&#39;</span><span class="p">:</span>
                <span class="n">damage_function</span><span class="p">()</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F916</span><span class="s1"> Processing FAIR CE ...&#39;</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Looking ahead into the future </span><span class="se">\U0001F31E</span><span class="s1"> </span><span class="se">\U0001F975</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption_no_pulse</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption_pulse</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fair_marginal_damages_ce</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fair_marginal_damages</span>

        <span class="k">def</span> <span class="nf">scc</span><span class="p">():</span>
            <span class="n">damage_function</span><span class="p">()</span>
            <span class="n">fair_ce</span><span class="p">()</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F916</span><span class="s1"> Processing SCC calculation ...&#39;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Is going to be expensive </span><span class="se">\U0001F4B8</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scc</span>

        <span class="n">course_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;damage_function&#39;</span><span class="p">:</span> <span class="n">damage_function</span><span class="p">,</span>
            <span class="s1">&#39;fair_ce&#39;</span><span class="p">:</span> <span class="n">fair_ce</span><span class="p">,</span>
            <span class="s1">&#39;scc&#39;</span><span class="p">:</span> <span class="n">scc</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">course_dict</span><span class="p">[</span><span class="n">course</span><span class="p">]()</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F389</span><span class="s1"> Task is done. Menu is a free-elf </span><span class="se">\U0001F389</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Check out results </span><span class="se">\U0001F4BE</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\U0001F525</span><span class="s1"> </span><span class="si">{</span><span class="n">course</span><span class="si">}</span><span class="s1"> is not a valid option: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Oh boy! </span><span class="se">\U0001F64A</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return dict with class attributes for output metadata</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">            A dict Class metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">scc_multiverse</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Sector&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span>
            <span class="s1">&#39;Menu type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="s1">&#39;Discount type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="p">,</span>
            <span class="s1">&#39;Discount level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_level</span><span class="p">,</span>
            <span class="s1">&#39;Extrapolation subset start&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_start_year</span><span class="p">,</span>
            <span class="s1">&#39;Extrapolation subset end&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_end_year</span><span class="p">,</span>
            <span class="s1">&#39;Extrapolation end&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_end_year</span><span class="p">,</span>
            <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span>
            <span class="s1">&#39;User&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;USER&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Machine&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Runtime&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Integration version&#39;</span><span class="p">:</span> <span class="n">scc_multiverse</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s1">&#39;Conda environment PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CONDA_PREFIX&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Path file GMST&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">gmst_path</span><span class="p">,</span>
            <span class="s1">&#39;Paths EconVars (GDP, pop)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_vars</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s1">&#39;Data subset&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_dict</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">meta</span>

<div class="viewcode-block" id="MainRecipe.ce_cc_calculation"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.ce_cc_calculation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">ce_cc_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate CE damages depending on discount type</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="MainRecipe.ce_no_cc_calculation"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.ce_no_cc_calculation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">ce_no_cc_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate GDP CE depending on discount type.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculated_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate damages (difference between CEs) for collapsing</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="nd">@cachedproperty</span>
    <span class="k">def</span> <span class="nf">global_damages_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate global collapsed damages for a desired discount type</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@cachedproperty</span>
    <span class="k">def</span> <span class="nf">ce_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Certainty Equivalence for Damages</span>

<span class="sd">        This function returns the certainty equivalence of the damages, defined</span>
<span class="sd">        as GDP per capita less the projected monetized damages. This damages</span>
<span class="sd">        will be used to calculate final damages pre-FAIR and will have an</span>
<span class="sd">        aditional coordinate taking the `cls.discounting_type` into account.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ce_cc_calculation</span><span class="p">()</span>

    <span class="nd">@cachedproperty</span>
    <span class="k">def</span> <span class="nf">ce_no_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Certainty Equivalence for GDP per capita.</span>

<span class="sd">        This method calculates CE for consumption using the GDP per capita. If</span>
<span class="sd">        the menu option does not need it, it will return raw GDP per capita</span>
<span class="sd">        depending on the user options or might be overriden by the child class</span>
<span class="sd">        if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_no_cc_calculation</span><span class="p">()</span>

    <span class="nd">@cachedproperty</span>
    <span class="k">def</span> <span class="nf">global_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Calculate collapsed damages for a desired discount type</span>

<span class="sd">        This function just calculate the damages by taking the difference</span>
<span class="sd">        between ce_no_cc and ce_cc. The resulting array operation is</span>
<span class="sd">        aggregated and multiplied by population or across SSPs if needed by the</span>
<span class="sd">        discount type.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">            pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_damages_calculation</span><span class="p">()</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;damage_function_points&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">damage_function_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Build damage function</span>

<span class="sd">        This function takes the `global_damages` and transform the data to</span>
<span class="sd">        add the GMST data to each GCM/RCP/year.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_merge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_damages</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">gmst</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;gcm&#39;</span><span class="p">,</span> <span class="s1">&#39;rcp&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df_merge</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;damage_function_coefficients&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">damage_function_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Fit a yearly relationship between GMST and damages for each of the</span>
<span class="sd">        discount types.</span>

<span class="sd">        Following Carleton et. al. (2020). After creating the damage function,</span>
<span class="sd">        we fit a set of yearly regression using a user defined rolling window.</span>
<span class="sd">        More detais in: `fair.estimation`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">betas_ssp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ssp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span><span class="s1">&#39;ssp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

                <span class="c1"># Subset dataframe to specific SSP </span>
                <span class="n">fit_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span><span class="s1">&#39;ssp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ssp</span>
                <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;global_damages_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;damages&#39;</span><span class="p">})</span>

                <span class="c1"># Fit damage function curves using the data subset</span>
                <span class="n">damage_hats_ssp</span> <span class="o">=</span> <span class="n">estimate_damages_betas</span><span class="p">(</span>
                    <span class="n">damage_function</span><span class="o">=</span><span class="n">fit_subset</span><span class="p">,</span>
                    <span class="n">type_estimation</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span>
                    <span class="n">return_preds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">damage_hats_ssp</span> <span class="o">=</span> <span class="n">damage_hats_ssp</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">discount_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="p">,</span>
                    <span class="n">ssp</span><span class="o">=</span><span class="n">ssp</span><span class="p">)</span>
                <span class="n">betas_ssp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damage_hats_ssp</span><span class="p">)</span>

            <span class="n">betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">betas_ssp</span><span class="p">)</span> 
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;discount_type&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;ramsey&#39;</span><span class="p">:</span>
            <span class="n">betas_ssp_iam</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ssp</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="o">.</span><span class="n">ssp</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="p">):</span>

                <span class="c1"># Subset dataframe to specific SSP-IAM combination. </span>
                <span class="n">fit_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span><span class="s1">&#39;ssp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ssp</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;global_damages_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;damages&#39;</span><span class="p">})</span>

                <span class="c1"># Fit damage function curves using the data subset</span>
                <span class="n">damage_hats</span> <span class="o">=</span> <span class="n">estimate_damages_betas</span><span class="p">(</span>
                    <span class="n">damage_function</span><span class="o">=</span><span class="n">fit_subset</span><span class="p">,</span>
                    <span class="n">type_estimation</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span>
                    <span class="n">return_preds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Add variables</span>
                <span class="n">damage_hats</span> <span class="o">=</span> <span class="n">damage_hats</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                    <span class="s1">&#39;discount_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="p">,</span>
                    <span class="s1">&#39;ssp&#39;</span><span class="p">:</span> <span class="n">ssp</span><span class="p">,</span>
                    <span class="s1">&#39;iam&#39;</span> <span class="p">:</span> <span class="n">model</span><span class="p">})</span>
                <span class="n">betas_ssp_iam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damage_hats</span><span class="p">)</span>

            <span class="n">betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">betas_ssp_iam</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="s1">&#39;discount_type&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;wr&#39;</span><span class="p">:</span>
            <span class="c1"># Fit damage function across all SSP-IAM combinations, as expected</span>
            <span class="c1"># from the Weitzman-Ramsey discounting</span>
            <span class="n">fit_subset</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_points</span><span class="o">.</span>
                <span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;collapsed_damages_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;damages&#39;</span><span class="p">})</span>
            <span class="p">)</span>

            <span class="n">damage_hats</span> <span class="o">=</span> <span class="n">estimate_damages_betas</span><span class="p">(</span>
                <span class="n">damage_function</span><span class="o">=</span><span class="n">fit_subset</span><span class="p">,</span>
                <span class="n">type_estimation</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span>
                <span class="n">return_preds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">betas</span> <span class="o">=</span> <span class="n">damage_hats</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">discount_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="p">,</span>
                <span class="n">ssp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damages</span><span class="o">.</span><span class="n">ssp</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span>
                <span class="n">iam</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damages</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="s1">&#39;discount_type&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1"> is not available&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">betas</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;damage_function_fit&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">damage_function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Calculate damage function predicted values using class</span>
<span class="sd">        damage_function_coefficients</span>

<span class="sd">        This class property contains all predictions for a menu damage</span>
<span class="sd">        function option by using the coefficients in</span>
<span class="sd">        damage_function_coefficients. Here we use `get_the_hats` function to</span>
<span class="sd">        calculate the dot product between the coefficients and an array of</span>
<span class="sd">        temperature anomalies from 0 to 11 with a 0.25 step. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">coefs_df</span> <span class="o">=</span> <span class="p">(</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="o">.</span>
            <span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span>
            <span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ssp</span> <span class="ow">in</span> <span class="n">coefs_df</span><span class="o">.</span><span class="n">ssp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">betas</span> <span class="o">=</span> <span class="n">coefs_df</span><span class="p">[</span><span class="n">coefs_df</span><span class="o">.</span><span class="n">ssp</span> <span class="o">==</span> <span class="n">ssp</span><span class="p">]</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">get_the_hats</span><span class="p">(</span><span class="n">betas</span><span class="p">[[</span><span class="s1">&#39;cons&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_1&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_2&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]])</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">betas_all</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ssp</span><span class="o">=</span><span class="n">ssp</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">betas_all</span><span class="p">)</span>

            <span class="n">hats_array</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span><span class="o">.</span>
                <span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">])</span><span class="o">.</span>
                <span class="n">to_xarray</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;ramsey&#39;</span><span class="p">:</span>
            <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ssp</span><span class="p">,</span> <span class="n">iam</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">coefs_df</span><span class="o">.</span><span class="n">ssp</span><span class="p">,</span> <span class="n">coefs_df</span><span class="o">.</span><span class="n">iam</span><span class="p">):</span>
                <span class="n">betas</span> <span class="o">=</span> <span class="n">coefs_df</span><span class="p">[(</span><span class="n">coefs_df</span><span class="o">.</span><span class="n">ssp</span> <span class="o">==</span> <span class="n">ssp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coefs_df</span><span class="o">.</span><span class="n">iam</span> <span class="o">==</span> <span class="n">iam</span><span class="p">)]</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">get_the_hats</span><span class="p">(</span><span class="n">betas</span><span class="p">[[</span><span class="s1">&#39;cons&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_1&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_2&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]])</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">betas_all</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ssp</span><span class="o">=</span><span class="n">ssp</span><span class="p">,</span> <span class="n">iam</span><span class="o">=</span><span class="n">iam</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">betas_all</span><span class="p">)</span>

            <span class="n">hats_array</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span><span class="o">.</span>
                <span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;iam&#39;</span><span class="p">])</span><span class="o">.</span>
                <span class="n">to_xarray</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span> <span class="o">==</span> <span class="s1">&#39;wr&#39;</span><span class="p">:</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">get_the_hats</span><span class="p">(</span><span class="n">coefs_df</span><span class="p">[[</span><span class="s1">&#39;cons&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_1&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_2&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]])</span>
                <span class="n">betas_all</span> <span class="o">=</span> <span class="n">betas_all</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ssp</span><span class="o">=</span><span class="n">ssp</span><span class="p">,</span> <span class="n">iam</span><span class="o">=</span><span class="n">iam</span><span class="p">)</span>

                <span class="n">hats_array</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">betas_all</span><span class="o">.</span>
                    <span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;iam&#39;</span><span class="p">])</span><span class="o">.</span>
                    <span class="n">to_xarray</span><span class="p">()</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="si">}</span><span class="s1"> is not a valid option&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hats_array</span>

    <span class="nd">@cachedproperty</span>
    <span class="k">def</span> <span class="nf">fair_marginal_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate marginal damages per puff of CO2 using FAIR for the</span>
<span class="sd">        baseline option.</span>

<span class="sd">        This function takes the coefficients of the estimated responses of</span>
<span class="sd">        damages to temeperature anomalies and calculate the predicted damages</span>
<span class="sd">        using the FAIR anomalies.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">damages_pulse</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_pulse</span><span class="p">,</span>
                                        <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>
        <span class="n">damages_control</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_baselines</span><span class="p">,</span>
                                          <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>

        <span class="n">marginal_damages</span> <span class="o">=</span> <span class="p">(</span><span class="n">damages_pulse</span> <span class="o">-</span> <span class="n">damages_control</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">expand_dims</span><span class="p">({</span>
                <span class="s1">&#39;type_fair&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;full_uncertainty&#39;</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_median_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">damages_pulse_median</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_median_run</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">pulse</span><span class="o">=</span><span class="s1">&#39;pulse&#39;</span><span class="p">),</span>
                <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>
            <span class="n">damages_control_median</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_median_run</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">pulse</span><span class="o">=</span><span class="s1">&#39;rcp&#39;</span><span class="p">),</span>
                <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>

            <span class="n">median_marginal_damages</span> <span class="o">=</span> <span class="p">(</span><span class="n">damages_pulse_median</span> <span class="o">-</span>
                                       <span class="n">damages_control_median</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">expand_dims</span><span class="p">({</span>
                    <span class="s1">&#39;type_fair&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;parameter_median&#39;</span><span class="p">]</span>
                <span class="p">})</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

            <span class="n">computed_damages</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">marginal_damages</span><span class="p">,</span> <span class="n">median_marginal_damages</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;type_fair&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">computed_damages</span> <span class="o">=</span> <span class="n">marginal_damages</span>

        <span class="k">return</span> <span class="n">computed_damages</span>

<div class="viewcode-block" id="MainRecipe.global_consumption_calculation"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.global_consumption_calculation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">global_consumption_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Global consumption calculation</span>

<span class="sd">        This method calculates the global consumption calculation needed to</span>
<span class="sd">        calculate damages using the FAIR product. Global consumptions is the</span>
<span class="sd">        consumption baseline we use to calculate damages in an especific menu</span>
<span class="sd">        option. The purpose of this is to transform damages into consumptions</span>
<span class="sd">        and be able to calculate certainty equivalences. </span>

<span class="sd">        Since FAIR values go beyond 2100, we extrapolate global consumption to</span>
<span class="sd">        2300 using the method defined in `ex_method`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            xr.DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;global_consumption&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">global_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Global consumption </span>

<span class="sd">        This property holds the global consumption calculation needed to</span>
<span class="sd">        calculate damages using the FAIR product. Global consumptions is the</span>
<span class="sd">        consumption baseline we use to calculate damages in an especific menu</span>
<span class="sd">        option. The purpose of this is to transform damages into consumptions</span>
<span class="sd">        and be able to calculate certainty equivalences. Since FAIR values go</span>
<span class="sd">        beyond 2100, we extrapolate global consumption to 2300 using the method</span>
<span class="sd">        defined in `ex_method` (using the function in `EconVars.extrapolate()`)</span>

<span class="sd">        This function iterates through the different discount options defined</span>
<span class="sd">        in the class and stores all results in an nd-array with the</span>
<span class="sd">        `discount_type` coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption_calculation</span><span class="p">()</span>

        <span class="n">extrapolate_cons</span> <span class="o">=</span> <span class="n">EconVars</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span>
            <span class="n">xr_array</span><span class="o">=</span><span class="n">array</span><span class="p">,</span>
            <span class="n">start_year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_start_year</span><span class="p">,</span>
            <span class="n">end_year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_subset_end_year</span><span class="p">,</span>
            <span class="n">interp_year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_end_year</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">extrapolate_cons</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;global_consumption_no_pulse&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">global_consumption_no_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Global consumption under FAIR control scenario.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fair_damages_control</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_baselines</span><span class="p">,</span>
                                               <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption</span> <span class="o">-</span> <span class="n">fair_damages_control</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;global_consumption_pulse&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">global_consumption_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Global consumption under pulse scenario</span>

<span class="sd">        This function, as the others in this class calculate the </span>
<span class="sd">        `global_consumption_pulse` parameter depending on the discount_type</span>
<span class="sd">        passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fair_damages_pulse</span> <span class="o">=</span> <span class="n">compute_damages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">climate</span><span class="o">.</span><span class="n">fair_pulse</span><span class="p">,</span>
                                             <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damage_function_coefficients</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_consumption</span> <span class="o">-</span> <span class="n">fair_damages_pulse</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fair_pulse_damages&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ce_fair_pulse_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Certainty Equivalence for Global consumption under FAIR pulse</span>

<span class="sd">        This is the CE for global damages under FAIR pulse scenarios. This is</span>
<span class="sd">        the equivalent of `ce_damages`, but for FAIR damages. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ce_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_equivalence</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_consumption_pulse</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">],</span>
                                      <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ce_array</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fair_no_pulse_damages&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ce_fair_no_pulse_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Certainty Equivalnece for Global consumption under FAIR control</span>
<span class="sd">        climate</span>

<span class="sd">        This is the CE for global consumption under FAIR control scenarios.</span>
<span class="sd">        This is equivalent to `ce_no_damages`, but for FAIR damages. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ce_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_equivalence</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_consumption_no_pulse</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">],</span>
                                      <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ce_array</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fair_marginal_damages_ce&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fair_marginal_damages_ce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Global damages from FAIR</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ce_fair_pulse_damages</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_fair_no_pulse_damages</span><span class="p">)</span>

    <span class="nd">@cachedproperty</span>
    <span class="nd">@save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;scc&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_scc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Aggregate damages for different discount rates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">discounted_damages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounted_fair_damages</span><span class="p">(</span>
            <span class="n">damages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fair_marginal_damages</span><span class="p">,</span>
            <span class="n">discrate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discounting_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">discounted_damages</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MainRecipe.discounted_fair_damages"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.discounted_fair_damages">[docs]</a>    <span class="k">def</span> <span class="nf">discounted_fair_damages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">damages</span><span class="p">,</span> <span class="n">discrate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Discount FAIR damages to present value according to discounting</span>
<span class="sd">        type</span>

<span class="sd">        Evaluate damages according to different discount rates. The available</span>
<span class="sd">        options are the same we have on the menu options: </span>
<span class="sd">         - ramsey</span>
<span class="sd">         - rw (ramsey-weitzmann)</span>
<span class="sd">         - constant (see: self.discrates to see the list of rates)</span>

<span class="sd">        The function will take an damage object with a `discount_rate`</span>
<span class="sd">        dimension and will subset it. Then it will calculate the discounted</span>
<span class="sd">        damages using the user-desired formula</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            - damages (xr.DataArray or xr.Dataset)  Array of damages with a</span>
<span class="sd">              `discount_type` dimension to subset the damages. </span>
<span class="sd">            - discrate (str) A discrate formula. The available options are:</span>
<span class="sd">              &#39;rw&#39;, &#39;ramsey&#39;, and &#39;constant&#39;. Be aware that the constant rates</span>
<span class="sd">              are class-wide defined. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            xr.Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Filter by discrate if available. Alternatively, treat damages equally</span>
        <span class="c1"># for all discount rates.</span>

        <span class="k">if</span> <span class="n">discrate</span> <span class="o">==</span> <span class="s1">&#39;ramsey&#39;</span><span class="p">:</span>
            <span class="n">pvd_damages</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_discount_factors</span> <span class="o">*</span>
                           <span class="n">damages</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">discrate</span> <span class="o">==</span> <span class="s1">&#39;wr&#39;</span><span class="p">:</span>
            <span class="n">pvd_damages</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream_discount_factors</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ssp&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">])</span> <span class="o">*</span>
                <span class="n">damages</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">discrate</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">pvd_damages</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">damages</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
                  <span class="o">**</span><span class="p">(</span><span class="n">damages</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">PULSE_YEAR</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_disc_rates</span><span class="p">],</span>
                <span class="n">dim</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const_disc_rates</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;discrate&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pvd_damages</span></div>

<div class="viewcode-block" id="MainRecipe.c_equivalence"><a class="viewcode-back" href="../../../source/scc_multiverse.menu.html#scc_multiverse.menu.main_recipe.MainRecipe.c_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">c_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">array</span><span class="p">,</span>
                      <span class="n">dims</span><span class="p">,</span>
                      <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Certainty Equality</span>

<span class="sd">        This function calculates the certainty equality assuming a CRRA utility</span>
<span class="sd">        function. This CE gives us the level of consumption that makes a</span>
<span class="sd">        representative agent in an IR indifferent from any state of the world. </span>
<span class="sd">        This is relevant particularly in the dimensions used here.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        array xr.Dataset or xr.DatArray</span>
<span class="sd">            A `xarray` object containing consumption numbers.</span>
<span class="sd">        dims list </span>
<span class="sd">            List of dimensions to use in aggregation. </span>
<span class="sd">        func obj </span>
<span class="sd">            If user desired a different utility function to the CRRA, this</span>
<span class="sd">            argument can take a `lambda` function where `array` is the main</span>
<span class="sd">            variable.</span>
<span class="sd">        weights xr.DataArray</span>
<span class="sd">            Array with weights for aggregation calculation. `None` by default.</span>
<span class="sd">        func_args:</span>
<span class="sd">            Other arguments passed to `func`</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            xarray.Dataset with CEs over the desired dims</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">))</span>
            <span class="n">utility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">array</span><span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exp_utility</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp_utility</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>

            <span class="n">ce_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_utility</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">))</span> <span class="o">**</span> <span class="n">exp</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ce_array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">func_args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Custom function not conforming with array: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ce_array</span></div></div>


</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Ivan Higuera-Mendieta.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>